<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Roast Planner</title>
  <style>
    body { font-family: system-ui; padding: 20px; background:#fafafa; }
    table { border-collapse: collapse; width:100%; margin-bottom:20px; background:white; }
    th, td { border:1px solid #ddd; padding:6px; text-align:center; }
    th { background:#f0f0f0; }
    input, select { width:100%; }
    button { padding:6px 10px; margin:4px; }
  </style>
</head>
<body>

<h1>Roast Planner (Working)</h1>

<button onclick="addRoastRow()">âž• Add Roast</button>

<h2>Roast Plan</h2>
<table id="roastTable"></table>

<h2>Add Green Coffee</h2>
<input id="gc_name" placeholder="Coffee name">
<input id="gc_batch" type="number" placeholder="Batch size kg">
<input id="gc_loss" type="number" placeholder="Roast loss %">
<input id="gc_stock" type="number" placeholder="Green stock kg">
<button onclick="addGreenCoffee()">Add Coffee</button>

<h2>Green Coffee Stock</h2>
<table id="stockTable"></table>

<script>
/* ---------- STATE ---------- */

let greenCoffeeStock = [
  { id: crypto.randomUUID(), name:"Ethiopia", batchSizeKg:12, roastLossPct:12, greenStockKg:300, isActive:true }
];

let roastPlans = [];

/* ---------- CALC ---------- */

function calculateRoast(p, c) {
  const order = Number(p.orderWeight) || 0;
  const wholesale = Number(p.wholesale) || 0;
  const retail = Number(p.retail) || 0;
  const bar = Number(p.bar) || 0;

  const greenReq = order / (1 - c.roastLossPct / 100);
  const batches = Math.ceil(greenReq / c.batchSizeKg) || 0;
  const greenInput = batches * c.batchSizeKg;
  const roasted = greenInput * (1 - c.roastLossPct / 100);
  const allocated = wholesale + retail;
  const leftover = roasted - (allocated + bar);

  return { batches, greenInput, roasted, leftover, allocated };
}

/* ---------- ACTIONS ---------- */

function addRoastRow() {
  const active = greenCoffeeStock.find(c => c.isActive);
  if (!active) return alert("No active coffee");
  roastPlans.push({ coffeeId:active.id, orderWeight:0, wholesale:0, retail:0, bar:0 });
  render();
}

function addGreenCoffee() {
  if (!gc_name.value) return;
  greenCoffeeStock.push({
    id: crypto.randomUUID(),
    name: gc_name.value,
    batchSizeKg: Number(gc_batch.value),
    roastLossPct: Number(gc_loss.value),
    greenStockKg: Number(gc_stock.value),
    isActive:true
  });
  gc_name.value = gc_batch.value = gc_loss.value = gc_stock.value = "";
  render();
}

/* ---------- RENDER ---------- */

function render() {
  renderRoastTable();
  renderStockTable();
}

function renderRoastTable() {
  roastTable.innerHTML = `
    <tr>
      <th>Coffee</th><th>Order kg</th><th>Wholesale</th><th>Retail</th><th>Bar</th>
      <th>Batches</th><th>Green kg</th><th>Roasted kg</th><th>Leftover</th>
      <th>150g</th><th>200g</th><th>250g</th><th>1kg</th>
    </tr>`;

  roastPlans.forEach((p, i) => {
    const c = greenCoffeeStock.find(x => x.id === p.coffeeId);
    const r = calculateRoast(p, c);

    roastTable.innerHTML += `
      <tr>
        <td>
          <select onchange="roastPlans[${i}].coffeeId=this.value;render()">
            ${greenCoffeeStock.filter(x=>x.isActive||x.id===p.coffeeId)
              .map(x=>`<option value="${x.id}" ${x.id===p.coffeeId?"selected":""}>${x.name}</option>`).join("")}
          </select>
        </td>
        <td><input type="number" value="${p.orderWeight}" oninput="roastPlans[${i}].orderWeight=this.value;render()"></td>
        <td><input type="number" value="${p.wholesale}" oninput="roastPlans[${i}].wholesale=this.value;render()"></td>
        <td><input type="number" value="${p.retail}" oninput="roastPlans[${i}].retail=this.value;render()"></td>
        <td><input type="number" value="${p.bar}" oninput="roastPlans[${i}].bar=this.value;render()"></td>
        <td>${r.batches}</td>
        <td>${r.greenInput.toFixed(2)}</td>
        <td>${r.roasted.toFixed(2)}</td>
        <td>${r.leftover.toFixed(2)}</td>
        <td>${Math.floor(r.allocated/0.15)}</td>
        <td>${Math.floor(r.allocated/0.2)}</td>
        <td>${Math.floor(r.allocated/0.25)}</td>
        <td>${Math.floor(r.allocated/1)}</td>
      </tr>`;
  });
}

function renderStockTable() {
  stockTable.innerHTML = `<tr><th>Coffee</th><th>Remaining kg</th></tr>`;
  greenCoffeeStock.forEach(c=>{
    let used=0;
    roastPlans.forEach(p=>{
      if(p.coffeeId===c.id) used+=calculateRoast(p,c).greenInput;
    });
    const remaining=c.greenStockKg-used;
    if(remaining<=0) c.isActive=false;
    stockTable.innerHTML+=`<tr><td>${c.name}</td><td>${remaining.toFixed(2)}</td></tr>`;
  });
}

render();
</script>
</body>
</html>
