<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Roast Planner</title>
  <style>
    body { font-family: system-ui; padding: 20px; background:#fafafa; }
    table { border-collapse: collapse; width:100%; margin-bottom:20px; background:white; }
    th, td { border:1px solid #ddd; padding:6px; text-align:center; }
    th { background:#f0f0f0; }
    input, select { width:100%; }
    button { padding:6px 10px; margin:4px; }
    .card { background:white; padding:12px; border-radius:6px; }
  </style>
</head>
<body>

<h1>Roast Planner (Fixed)</h1>

<div id="dashboard"></div>

<button onclick="addRoastRow()">âž• Add Roast</button>

<h2>Roast Plan</h2>
<table id="roastTable"></table>

<h2>Add Green Coffee</h2>
<input id="gc_name" placeholder="Coffee name">
<input id="gc_batch" type="number" placeholder="Batch size kg">
<input id="gc_loss" type="number" placeholder="Roast loss %">
<input id="gc_stock" type="number" placeholder="Green stock kg">
<button onclick="addGreenCoffee()">Add Coffee</button>

<h2>Green Coffee Stock</h2>
<table id="stockTable"></table>

<script>
/* ---------- STATE ---------- */

let greenCoffeeStock = [
  {
    id: crypto.randomUUID(),
    name: "Ethiopia",
    batchSizeKg: 12,
    roastLossPct: 12,
    greenStockKg: 300,
    isActive: true
  }
];

let roastPlans = [];

/* ---------- CALCULATION ---------- */

function calculateRoast(plan, coffee) {
  const order = Number(plan.orderWeight) || 0;
  const wholesale = Number(plan.wholesale) || 0;
  const retail = Number(plan.retail) || 0;
  const bar = Number(plan.bar) || 0;

  const greenRequired = order / (1 - coffee.roastLossPct / 100);
  const batches = Math.ceil(greenRequired / coffee.batchSizeKg) || 0;
  const greenInput = batches * coffee.batchSizeKg;
  const roasted = greenInput * (1 - coffee.roastLossPct / 100);
  const leftover = roasted - (wholesale + retail + bar);

  return { batches, greenInput, roasted, leftover };
}

/* ---------- ACTIONS ---------- */

function addRoastRow() {
  const active = greenCoffeeStock.find(c => c.isActive);
  if (!active) {
    alert("No active green coffee available");
    return;
  }

  roastPlans.push({
    id: crypto.randomUUID(),
    coffeeId: active.id,
    orderWeight: 0,
    wholesale: 0,
    retail: 0,
    bar: 0
  });

  render();
}

function addGreenCoffee() {
  const name = gc_name.value.trim();
  if (!name) return alert("Name required");

  greenCoffeeStock.push({
    id: crypto.randomUUID(),
    name,
    batchSizeKg: Number(gc_batch.value),
    roastLossPct: Number(gc_loss.value),
    greenStockKg: Number(gc_stock.value),
    isActive: true
  });

  gc_name.value = gc_batch.value = gc_loss.value = gc_stock.value = "";
  render();
}

/* ---------- RENDER ---------- */

function renderRoastTable() {
  roastTable.innerHTML = `
    <tr>
      <th>Coffee</th><th>Order kg</th><th>Wholesale</th><th>Retail</th><th>Bar</th>
      <th>Batches</th><th>Green kg</th><th>Roasted kg</th><th>Leftover</th>
    </tr>
  `;

  roastPlans.forEach(plan => {
    const coffee = greenCoffeeStock.find(c => c.id === plan.coffeeId);
    const r = calculateRoast(plan, coffee);

    roastTable.innerHTML += `
      <tr>
        <td>
          <select onchange="plan.coffeeId=this.value;render()">
            ${greenCoffeeStock
              .filter(c => c.isActive || c.id === plan.coffeeId)
              .map(c => `<option value="${c.id}" ${c.id===plan.coffeeId?"selected":""}>${c.name}</option>`)
              .join("")}
          </select>
        </td>
        <td><input type="number" value="${plan.orderWeight}" oninput="plan.orderWeight=this.value;render()"></td>
        <td><input type="number" value="${plan.wholesale}" oninput="plan.wholesale=this.value;render()"></td>
        <td><input type="number" value="${plan.retail}" oninput="plan.retail=this.value;render()"></td>
        <td><input type="number" value="${plan.bar}" oninput="plan.bar=this.value;render()"></td>
        <td>${r.batches}</td>
        <td>${r.greenInput.toFixed(2)}</td>
        <td>${r.roasted.toFixed(2)}</td>
        <td>${r.leftover.toFixed(2)}</td>
      </tr>
    `;
  });
}

function renderStockTable() {
  stockTable.innerHTML = `<tr><th>Coffee</th><th>Remaining kg</th></tr>`;

  greenCoffeeStock.forEach(c => {
    let used = 0;
    roastPlans.forEach(p => {
      if (p.coffeeId === c.id) {
        used += calculateRoast(p, c).greenInput;
      }
    });

    const remaining = c.greenStockKg - used;
    if (remaining <= 0) c.isActive = false;

    stockTable.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${remaining.toFixed(2)}</td>
      </tr>
    `;
  });
}

function renderDashboard() {
  let totalBatches = 0;
  roastPlans.forEach(p => {
    const c = greenCoffeeStock.find(x => x.id === p.coffeeId);
    totalBatches += calculateRoast(p, c).batches;
  });

  dashboard.innerHTML = `
    <div class="card">
      Roasts: ${roastPlans.length} |
      Total batches: ${totalBatches}
    </div>
  `;
}

function render() {
  renderRoastTable();
  renderStockTable();
  renderDashboard();
}

render();
</script>
</body>
</html>
